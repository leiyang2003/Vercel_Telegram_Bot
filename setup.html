<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Setup - Vercel Telegram Bot</title>
  <link rel="stylesheet" href="/base.css">
  <style>
    body { font-family: var(--font-sans); margin: 0; padding: 0; background: var(--app-bg-page); color: var(--app-text); }
    .main { max-width: 720px; margin: 0 auto; padding: var(--gap-xl) var(--page-padding-home); }
    .page-title { font-size: 1.5rem; font-weight: 600; margin: 0 0 var(--gap-xl); }
    .agent-card { background: #fff; border: 1px solid var(--app-card-border); border-radius: 14px; padding: var(--gap-lg); margin-bottom: var(--gap-md); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--gap-md); }
    .agent-card .info { flex: 1; min-width: 200px; }
    .agent-card .info strong { display: block; margin-bottom: 4px; }
    .agent-card .info span { font-size: var(--font-size-small); color: var(--app-text-muted); }
    .agent-card .actions { display: flex; gap: var(--gap-sm); }
    .edit-form { display: none; margin-top: var(--gap-lg); padding: var(--gap-lg); background: #F8F9FA; border-radius: var(--radius-md); }
    .edit-form.active { display: block; }
    #exportOutput { display: none; margin-top: var(--gap-md); padding: var(--gap-md); background: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; border-radius: var(--radius-md); max-height: 200px; overflow-y: auto; }
    #exportOutput.visible { display: block; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/setup" class="brand">Vercel Telegram Bot</a>
    <nav class="nav-top">
      <a href="/setup" class="active">Setup</a>
    </nav>
    <span id="auth-header"></span>
  </header>
  <script src="/auth.js"></script>
  <main class="main">
    <h1 class="page-title">Bot 管理</h1>
    <p class="hint" style="margin-bottom: var(--gap-xl);">每位用户最多可配置 4 个 Telegram Bot，每个 Bot 拥有独立的 Persona 与 Workspace。</p>

    <div id="agent-list"></div>

    <div class="card">
      <h3>添加 / 编辑 Bot</h3>
      <p class="hint" style="margin-bottom: var(--gap-md);">选择 slot 后填写并保存。保存后可「导出」获取本地运行命令。</p>
      <div class="form-row">
        <label>Slot</label>
        <select id="formSlot">
          <option value="bot_1">bot_1</option>
          <option value="bot_2">bot_2</option>
          <option value="bot_3">bot_3</option>
          <option value="bot_4">bot_4</option>
        </select>
      </div>
      <div class="form-row">
        <label>Display Name</label>
        <input type="text" id="formName" placeholder="e.g. QX, Support Bot">
      </div>
      <div class="form-row">
        <label>Telegram Bot Token (from @BotFather)</label>
        <input type="password" id="formToken" placeholder="123456:ABC...">
      </div>
      <div class="form-row">
        <label>Persona (system prompt)</label>
        <textarea id="formPersona" placeholder="You are a helpful assistant..."></textarea>
      </div>
      <div class="form-row">
        <label>Persona filename (saved under personas/&lt;slot&gt;/)</label>
        <input type="text" id="formPersonaFilename" value="persona.txt" placeholder="persona.txt">
      </div>
      <div style="display: flex; gap: var(--gap-sm); flex-wrap: wrap;">
        <button type="button" class="btn-save" id="btnSave">保存</button>
        <button type="button" class="btn-secondary" id="btnExport">导出运行命令</button>
        <a href="#" id="btnDownload" class="btn-secondary" style="text-decoration:none;line-height:2;" download>下载配置包</a>
        <label for="webhookBaseUrl" style="display:block;margin-top:var(--gap-md);font-size:0.9rem;">Webhook 基址（本地/ngrok 时必填）</label>
        <input type="text" id="webhookBaseUrl" placeholder="https://xxx.ngrok-free.dev 或留空（Vercel 自动）" style="width:100%;max-width:400px;margin-top:4px;padding:6px 8px;">
        <button type="button" class="btn-secondary" id="btnRegisterWebhook">启用 Vercel Webhook</button>
      </div>
      <div id="saveMessage" class="hint" style="margin-top: var(--gap-md);"></div>
      <pre id="exportOutput"></pre>
    </div>
  </main>
  <script>
(function () {
  const fetchOpts = { credentials: "same-origin" };
  const agentList = document.getElementById("agent-list");
  const formSlot = document.getElementById("formSlot");
  const formName = document.getElementById("formName");
  const formToken = document.getElementById("formToken");
  const formPersona = document.getElementById("formPersona");
  const formPersonaFilename = document.getElementById("formPersonaFilename");
  const btnSave = document.getElementById("btnSave");
  const btnExport = document.getElementById("btnExport");
  const btnRegisterWebhook = document.getElementById("btnRegisterWebhook");
  const saveMessage = document.getElementById("saveMessage");
  const exportOutput = document.getElementById("exportOutput");

  function setMessage(text, type) {
    saveMessage.textContent = text;
    saveMessage.className = type === "success" ? "hint" : type === "error" ? "error" : "hint";
  }

  function renderAgents(agents) {
    agentList.innerHTML = "";
    agents.forEach(function (a) {
      const card = document.createElement("div");
      card.className = "agent-card";
      const status = a.configured ? "已配置" : "未配置";
      card.innerHTML =
        '<div class="info">' +
          '<strong>' + (a.name || a.id) + '</strong>' +
          '<span>' + a.id + ' | ' + (a.persona_filename || "—") + ' | Token: ' + (a.token_masked || "—") + '</span>' +
        '</div>' +
        '<div class="actions">' +
          '<button type="button" class="btn-secondary edit-btn" data-slot="' + a.id + '">编辑</button>' +
          (a.configured ? '<button type="button" class="btn-secondary export-btn" data-slot="' + a.id + '">导出</button>' : '') +
          (a.configured ? '<a href="/api/bots/' + a.id + '/download" class="btn-secondary" download style="text-decoration:none;display:inline-block;line-height:2;">下载</a>' : '') +
        '</div>';
      agentList.appendChild(card);
    });

    document.querySelectorAll(".edit-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        formSlot.value = btn.dataset.slot;
        loadAgentIntoForm(btn.dataset.slot);
      });
    });
    document.querySelectorAll(".export-btn").forEach(function (btn) {
      btn.addEventListener("click", function () { doExport(btn.dataset.slot); });
    });
  }

  function loadAgentIntoForm(slotId) {
    fetch("/api/bots/" + slotId, fetchOpts)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        formSlot.value = data.id || slotId;
        formName.value = data.name || "";
        formToken.value = data.telegram_bot_token || "";
        formPersona.value = data.persona_text || "You are a helpful assistant.";
        formPersonaFilename.value = data.persona_filename || "persona.txt";
      })
      .catch(function () { setMessage("加载失败", "error"); });
  }

  function loadAgents() {
    fetch("/api/bots", fetchOpts)
      .then(function (r) {
        if (r.status === 401) { window.location.href = "/login?next=/setup"; return; }
        return r.json();
      })
      .then(function (data) {
        if (!data) return;
        renderAgents(data.agents || []);
      })
      .catch(function () { setMessage("加载 Bot 列表失败", "error"); });
  }

  formSlot.addEventListener("change", function () { loadAgentIntoForm(formSlot.value); });

  btnSave.addEventListener("click", function () {
    const slotId = formSlot.value;
    setMessage("保存中…", "");
    fetch("/api/bots/" + slotId, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({
        name: formName.value,
        telegram_bot_token: formToken.value,
        persona_text: formPersona.value,
        persona_filename: formPersonaFilename.value || "persona.txt",
      }),
    })
      .then(function (r) {
        return r.text().then(function (text) {
          try {
            var d = text ? JSON.parse(text) : {};
          } catch (e) {
            return { ok: false, data: { error: "Server error (non-JSON). Status: " + r.status + (text ? ". " + text.slice(0, 200) : "") } };
          }
          return { ok: r.ok, data: d };
        });
      })
      .then(function (res) {
        if (res.ok) { setMessage(res.data.message || "保存成功", "success"); loadAgents(); }
        else { setMessage(res.data.error || res.data.message || "保存失败", "error"); }
      })
      .catch(function (err) { setMessage("保存失败: " + (err.message || "网络错误"), "error"); });
  });

  function doExport(slotId) {
    exportOutput.classList.remove("visible");
    fetch("/api/bots/" + slotId + "/export", fetchOpts)
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (data.error) { setMessage(data.error, "error"); return; }
        exportOutput.textContent = data.command || "";
        exportOutput.classList.add("visible");
        setMessage("已导出，请复制下方命令在 telegramBOT 目录下运行。需先确保 ../telegramBOT 中存在 QX.py 等文件。", "success");
      })
      .catch(function () { setMessage("导出失败", "error"); });
  }

  btnExport.addEventListener("click", function () { doExport(formSlot.value); });

  btnRegisterWebhook.addEventListener("click", function () {
    const slotId = formSlot.value;
    setMessage("注册中…", "");
    var body = {};
    var baseUrl = (document.getElementById("webhookBaseUrl").value || "").trim();
    if (baseUrl) body.base_url = baseUrl;
    else if (window.location.protocol === "https:") body.base_url = window.location.origin;
    fetch("/api/bots/" + slotId + "/register-webhook", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(body),
    })
      .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }).catch(function () { return { ok: r.ok, data: {} }; }); })
      .then(function (res) {
        if (res.ok) { setMessage(res.data.message || "Webhook 已启用", "success"); }
        else { setMessage(res.data.error || "注册失败", "error"); }
      })
      .catch(function () { setMessage("注册失败", "error"); });
  });

  document.getElementById("btnDownload").addEventListener("click", function (e) {
    e.preventDefault();
    const slot = formSlot.value;
    if (!slot) return;
    window.location.href = "/api/bots/" + slot + "/download";
  });

  loadAgents();
  loadAgentIntoForm("bot_1");
})();
  </script>
</body>
</html>
